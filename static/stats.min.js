function parseCSVLine(e){const t=[];let a=!1,n="";for(let r=0;r<e.length;++r){const l=e[r];if('"'===l)a=!a;else if(" "!==l||a)n+=l;else for(n.length&&(t.push(n),n="");" "===e[r+1];)++r}return n.length&&t.push(n),t}async function fetchTable(e,t,a){const n=await fetch(e);if(!n.ok)return[];return(await n.text()).split("\n").filter((e=>e.trim())).map(parseCSVLine).filter((e=>!a||"0"!==e[t.indexOf(a)]&&"0.0"!==e[t.indexOf(a)])).map((e=>{let a={};return t.forEach(((t,n)=>a[t]=e[n])),a}))}function formatNumber(e){return e&&!isNaN(e)?Number(e).toLocaleString("de-DE"):"-"}function formatDate(e){if(!e)return"-";const[t,a,n]=e.split("-");return`${n}.${a}.${t}`}function renderHighlights(e){if(!e.length)return;const t=e[e.length-1],a=[{label:"Gesamtpunkte",value:formatNumber(t.total)},{label:"Tagespunkte",value:formatNumber(t.daily)},{label:"Gesamtrang",value:formatNumber(t.rank)},{label:"Länderrang",value:formatNumber(t.country_rank)},{label:"Veränderung (Tag)",value:formatNumber(t.rank_cng)}];document.getElementById("highlights").innerHTML=a.map((e=>`<div class="highlight-tile">\n            <h3>${e.label}</h3>\n            <p>${e.value}</p>\n        </div>`)).join("")}function renderChartTiles(){document.getElementById("charts").innerHTML=[{id:"totalPointsChart",title:"Gesamtpunkte"},{id:"rankChart",title:"Gesamtrang"},{id:"dailyPointsChart",title:"Tagespunkte"},{id:"countryRankChart",title:"Länderrang"}].map((e=>`<div class="chart-tile">\n            <h3>${e.title}</h3>\n            <canvas id="${e.id}"></canvas>\n        </div>`)).join("")}function makeTableSortable(e,t,a,n,r){let l=0,o=!1;!function i(d){const s=`<tr>${n.map(((e,t)=>`<th data-idx="${t}" class="sortable ${l===t?"active":""}">${e}${l===t?o?" ▲":" ▼":""}</th>`)).join("")}</tr>`,c=d.map((e=>`<tr>${t.map(((t,a)=>r(t,e[t]))).join("")}</tr>`)).join("");document.getElementById(e).innerHTML=`<thead>${s}</thead><tbody>${c}</tbody>`,document.querySelectorAll(`#${e} th.sortable`).forEach((e=>{e.onclick=()=>{const n=Number(e.dataset.idx);l===n?o=!o:(l=n,o=!0);const r=t[l];i([...a].sort(((e,t)=>{let a=e[r],n=t[r];return isNaN(a)||isNaN(n)||(a=Number(a),n=Number(n)),(a>n?1:a<n?-1:0)*(o?1:-1)})))}}))}(a)}function renderCharts(e){if(!e.length)return;const t=e.map((e=>formatDate(e.date))),a=e.map((e=>Number(e.total))),n=e.map((e=>Number(e.daily))),r=e.map((e=>Number(e.rank))),l=e.map((e=>Number(e.country_rank))),o={responsive:!0,plugins:{legend:{display:!1},tooltip:{enabled:!0,mode:"index",intersect:!1}},elements:{point:{radius:0},line:{borderWidth:3}},scales:{x:{grid:{display:!1}},y:{grid:{color:"#e5e7eb",lineWidth:1},ticks:{color:"#888"}}}};new Chart(document.getElementById("totalPointsChart").getContext("2d"),{type:"line",data:{labels:t,datasets:[{label:"Gesamtpunkte",data:a,borderColor:"#3b82f6",backgroundColor:"#3b82f633",fill:!1}]},options:o}),new Chart(document.getElementById("rankChart").getContext("2d"),{type:"line",data:{labels:t,datasets:[{label:"Gesamtrang",data:r,borderColor:"#22c55e",backgroundColor:"#22c55e33",fill:!1}]},options:{...o,scales:{...o.scales,y:{...o.scales.y,reverse:!0}}}}),new Chart(document.getElementById("dailyPointsChart").getContext("2d"),{type:"bar",data:{labels:t,datasets:[{label:"Tagespunkte",data:n,backgroundColor:"#fbbf24"}]},options:{...o,elements:{bar:{borderRadius:3}}}}),new Chart(document.getElementById("countryRankChart").getContext("2d"),{type:"line",data:{labels:t,datasets:[{label:"Länderrang",data:l,borderColor:"#8b5cf6",backgroundColor:"#8b5cf633",fill:!1}]},options:{...o,scales:{...o.scales,y:{...o.scales.y,reverse:!0}}}})}async function main(){const e=["date","total","daily","rank","rank_cng","team_rank","team_cng","country_rank","country_cng"],t=["project","total","share","today","daily","weekly","monthly","rank","rank_cng_day","rank_cng_week","rank_cng_month","team_rank","country_rank"],a=["rank","cpu","cores","os","total","daily","weekly","monthly","avg"],[n,r,l]=await Promise.all([fetchTable("db/daily",e,"total"),fetchTable("db/projects",t),fetchTable("db/hosts",a)]);renderHighlights(n),renderChartTiles(),renderCharts(n),makeTableSortable("dailyTable",e,n,["Datum","Gesamt","Tagespunkte","Rang","Δ Rang","Team-Rang","Δ Team","Land-Rang","Δ Land"],((e,t)=>"date"===e?`<td>${formatDate(t)}</td>`:`<td>${formatNumber(t)}</td>`)),makeTableSortable("projectsTable",t,r,["Projekt","Gesamt","Anteil","Heute","Täglich","Wöchentlich","Monatlich","Rang","Δ Tag","Δ Woche","Δ Monat","Team-Rang","Land-Rang"],((e,t)=>"project"===e?`<td>${t.replace(/^"|"$/g,"")}</td>`:`<td>${formatNumber(t)}</td>`)),makeTableSortable("hostsTable",a,l,["Rang","CPU","Cores","OS","Gesamt","Täglich","Wöchentlich","Monatlich","Ø"],((e,t)=>"cpu"===e||"os"===e?`<td>${t}</td>`:`<td>${formatNumber(t)}</td>`))}window.addEventListener("DOMContentLoaded",main);