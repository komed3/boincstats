function parseCSVLine(t){const e=[];let a=!1,n="";for(let r=0;r<t.length;++r){const o=t[r];if('"'===o)a=!a;else if(" "!==o||a)n+=o;else for(n.length&&(e.push(n),n="");" "===t[r+1];)++r}return n.length&&e.push(n),e}async function fetchTable(t,e,a){const n=await fetch(t);if(!n.ok)return[];return(await n.text()).split("\n").filter((t=>t.trim())).map(parseCSVLine).filter((t=>!a||"0"!==t[e.indexOf(a)]&&"0.0"!==t[e.indexOf(a)])).map((t=>{let a={};return e.forEach(((e,n)=>a[e]=t[n])),a}))}function formatNumber(t){return t&&!isNaN(t)?Number(t).toLocaleString("en-US"):"–"}function formatDiff(t){if(isNaN(t)||null==t)return"–";const e=Number(t);return e>0?`<diff class="up">+${formatNumber(e)}</diff>`:e<0?`<diff class="down">${formatNumber(e)}</diff>`:`<diff class="equal">±${formatNumber(e)}</diff>`}function formatDate(t){return t?new Date(t).toLocaleDateString("en-US",{year:"2-digit",month:"2-digit",day:"2-digit"}):"–"}function highlights(t){if(!t.length)return;const e=t[t.length-1];for(const[t,a,n]of[["total_points","total","formatNumber"],["daily_points","daily","formatNumber"],["world_rank","rank","formatNumber"],["country_rank","country_rank","formatNumber"],["rank_change","rank_cng","formatDiff"]])document.querySelector(`[data-item="${t}"]`).innerHTML=window[n](e[a])}function renderChartTiles(){document.getElementById("charts").innerHTML=[{id:"totalPointsChart",title:"Total Points"},{id:"rankChart",title:"World Rank"},{id:"dailyPointsChart",title:"Daily Points"},{id:"countryRankChart",title:"Country Rank"}].map((t=>`<div class="chart-tile">\n            <h3>${t.title}</h3>\n            <canvas id="${t.id}"></canvas>\n        </div>`)).join("")}function makeTableSortable(t,e,a,n,r){let o=0,l=!1;!function i(d){const s=`<tr>${n.map(((t,e)=>`<th data-idx="${e}" class="sortable ${o===e?"active":""}">${t}${o===e?l?" ▲":" ▼":""}</th>`)).join("")}</tr>`,c=d.map((t=>`<tr>${e.map(((e,a)=>r(e,t[e]))).join("")}</tr>`)).join("");document.getElementById(t).innerHTML=`<thead>${s}</thead><tbody>${c}</tbody>`,document.querySelectorAll(`#${t} th.sortable`).forEach((t=>{t.onclick=()=>{const n=Number(t.dataset.idx);o===n?l=!l:(o=n,l=!0);const r=e[o];i([...a].sort(((t,e)=>{let a=t[r],n=e[r];return isNaN(a)||isNaN(n)||(a=Number(a),n=Number(n)),(a>n?1:a<n?-1:0)*(l?1:-1)})))}}))}(a)}function renderCharts(t){if(!t.length)return;const e=t.map((t=>formatDate(t.date))),a=t.map((t=>Number(t.total))),n=t.map((t=>Number(t.daily))),r=t.map((t=>Number(t.rank))),o=t.map((t=>Number(t.country_rank))),l={responsive:!0,plugins:{legend:{display:!1},tooltip:{enabled:!0,mode:"index",intersect:!1}},elements:{point:{radius:0},line:{borderWidth:3}},scales:{x:{grid:{display:!1}},y:{grid:{color:"#e5e7eb",lineWidth:1},ticks:{color:"#888"}}}};new Chart(document.getElementById("totalPointsChart").getContext("2d"),{type:"line",data:{labels:e,datasets:[{label:"Gesamtpunkte",data:a,borderColor:"#3b82f6",backgroundColor:"#3b82f633",fill:!1}]},options:l}),new Chart(document.getElementById("rankChart").getContext("2d"),{type:"line",data:{labels:e,datasets:[{label:"Gesamtrang",data:r,borderColor:"#22c55e",backgroundColor:"#22c55e33",fill:!1}]},options:{...l,scales:{...l.scales,y:{...l.scales.y,reverse:!0}}}}),new Chart(document.getElementById("dailyPointsChart").getContext("2d"),{type:"bar",data:{labels:e,datasets:[{label:"Tagespunkte",data:n,backgroundColor:"#fbbf24"}]},options:{...l,elements:{bar:{borderRadius:3}}}}),new Chart(document.getElementById("countryRankChart").getContext("2d"),{type:"line",data:{labels:e,datasets:[{label:"Länderrang",data:o,borderColor:"#8b5cf6",backgroundColor:"#8b5cf633",fill:!1}]},options:{...l,scales:{...l.scales,y:{...l.scales.y,reverse:!0}}}})}async function main(){const t=["date","total","daily","rank","rank_cng","team_rank","team_cng","country_rank","country_cng"],e=["project","total","share","today","daily","weekly","monthly","rank","rank_cng_day","rank_cng_week","rank_cng_month","team_rank","country_rank"],a=["rank","cpu","cores","os","total","daily","weekly","monthly","avg"],[n,r,o]=await Promise.all([fetchTable("db/daily",t,"total"),fetchTable("db/projects",e),fetchTable("db/hosts",a)]);highlights(n),renderChartTiles(),renderCharts(n),makeTableSortable("dailyTable",t,n,["Datum","Gesamt","Tagespunkte","Rang","Δ Rang","Team-Rang","Δ Team","Land-Rang","Δ Land"],((t,e)=>"date"===t?`<td>${formatDate(e)}</td>`:`<td>${formatNumber(e)}</td>`)),makeTableSortable("projectsTable",e,r,["Projekt","Gesamt","Anteil","Heute","Täglich","Wöchentlich","Monatlich","Rang","Δ Tag","Δ Woche","Δ Monat","Team-Rang","Land-Rang"],((t,e)=>"project"===t?`<td>${e.replace(/^"|"$/g,"")}</td>`:`<td>${formatNumber(e)}</td>`)),makeTableSortable("hostsTable",a,o,["Rang","CPU","Cores","OS","Gesamt","Täglich","Wöchentlich","Monatlich","Ø"],((t,e)=>"cpu"===t||"os"===t?`<td>${e}</td>`:`<td>${formatNumber(e)}</td>`))}window.addEventListener("DOMContentLoaded",main);