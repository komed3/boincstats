function parseCSVLine(t){const e=[];let a=!1,n="";for(let r=0;r<t.length;++r){const o=t[r];if('"'===o)a=!a;else if(" "!==o||a)n+=o;else for(n.length&&(e.push(n),n="");" "===t[r+1];)++r}return n.length&&e.push(n),e}async function fetchTable(t,e,a){const n=await fetch(t);if(!n.ok)return[];return(await n.text()).split("\n").filter((t=>t.trim())).map(parseCSVLine).filter((t=>!a||"0"!==t[e.indexOf(a)]&&"0.0"!==t[e.indexOf(a)])).map((t=>{let a={};return e.forEach(((e,n)=>a[e]=t[n])),a}))}function formatNumber(t,e=0){return t&&!isNaN(t)?Number(t).toLocaleString("en-US",{minimumFractionDigits:e,maximumFractionDigits:e}):"–"}function formatDiff(t,e=0){if(isNaN(t)||null==t)return"–";const a=Number(t);return a>0?`<diff class="up">+${formatNumber(a,e)}</diff>`:a<0?`<diff class="down">${formatNumber(a,e)}</diff>`:'<diff class="equal">±0</diff>'}function formatDate(t){return t?new Date(t).toLocaleDateString("en-US",{year:"2-digit",month:"2-digit",day:"2-digit"}):"–"}function renderHighlights(t){if(!t.length)return;const e=t.length,a=t[e-1];document.querySelector('#highlights [data-item="total_points"]').innerHTML=formatNumber(a.total),document.querySelector('#highlights [data-item="average_points"]').innerHTML=formatNumber(a.total/e,1),document.querySelector('#highlights [data-item="world_rank"]').innerHTML=formatNumber(a.rank),document.querySelector('#highlights [data-item="country_rank"]').innerHTML=formatNumber(a.country_rank),document.querySelector('#highlights [data-item="rank_change"]').innerHTML=formatDiff(a.rank_cng)}function renderCharts(t){if(!t.length)return;const e=t.map((t=>formatDate(t.date))),a=t.map((t=>Number(t.total))),n=t.map((t=>Number(t.daily))),r=t.map((t=>Number(t.rank))),o=t.map((t=>Number(t.country_rank))),l={responsive:!0,plugins:{legend:{display:!1},tooltip:{enabled:!0,mode:"index",intersect:!1}},elements:{point:{radius:0},line:{borderWidth:3}},scales:{x:{grid:{color:"#f3f4f6",lineWidth:1}},y:{grid:{color:"#f3f4f6",lineWidth:1},ticks:{color:"#888"}}}};new Chart(document.getElementById("totalPointsChart").getContext("2d"),{type:"line",data:{labels:e,datasets:[{label:"Total Points",data:a,borderColor:"#3b82f6",backgroundColor:"#3b82f611",fill:!0}]},options:l}),new Chart(document.getElementById("rankChart").getContext("2d"),{type:"line",data:{labels:e,datasets:[{label:"World Rank",data:r,borderColor:"#22c55e",backgroundColor:"#22c55e11",fill:!0,stepped:!0}]},options:{...l,scales:{...l.scales,y:{...l.scales.y,reverse:!0}}}}),new Chart(document.getElementById("dailyPointsChart").getContext("2d"),{type:"bar",data:{labels:e,datasets:[{label:"Daily Points",data:n,backgroundColor:"#fbbf24"}]},options:{...l,elements:{bar:{borderRadius:3}},scales:{...l.scales,x:{...l.scales.x,offset:!0},y:{...l.scales.y,min:0}}}}),new Chart(document.getElementById("countryRankChart").getContext("2d"),{type:"line",data:{labels:e,datasets:[{label:"Country Rank",data:o,borderColor:"#8b5cf6",backgroundColor:"#8b5cf611",fill:!0,stepped:!0}]},options:{...l,scales:{...l.scales,y:{...l.scales.y,reverse:!0}}}})}function makeTableSortable(t,e,a,n,r){let o=0,l=!1;!function i(d){const s=`<tr>${n.map(((t,e)=>`<th data-idx="${e}" class="sortable ${o===e?"active":""}">${t}${o===e?l?" ▲":" ▼":""}</th>`)).join("")}</tr>`,c=d.map((t=>`<tr>${e.map(((e,a)=>r(e,t[e]))).join("")}</tr>`)).join("");document.getElementById(t).innerHTML=`<thead>${s}</thead><tbody>${c}</tbody>`,document.querySelectorAll(`#${t} th.sortable`).forEach((t=>{t.onclick=()=>{const n=Number(t.dataset.idx);o===n?l=!l:(o=n,l=!0);const r=e[o];i([...a].sort(((t,e)=>{let a=t[r],n=e[r];return isNaN(a)||isNaN(n)||(a=Number(a),n=Number(n)),(a>n?1:a<n?-1:0)*(l?1:-1)})))}}))}(a)}async function main(){const t=["date","total","daily","rank","rank_cng","team_rank","team_cng","country_rank","country_cng"],e=["project","total","share","today","daily","weekly","monthly","rank","rank_cng_day","rank_cng_week","rank_cng_month","team_rank","country_rank"],a=["rank","cpu","cores","os","total","daily","weekly","monthly","avg"],[n,r,o]=await Promise.all([fetchTable("db/daily",t,"total"),fetchTable("db/projects",e),fetchTable("db/hosts",a)]);renderHighlights(n),renderCharts(n),makeTableSortable("dailyTable",t,n,["date","Total","Daily","Rank","Δ Rank","Team Rank","Δ Team","Country Rank","Δ Country"],((t,e)=>"date"===t?`<td>${formatDate(e)}</td>`:t.endsWith("_cng")?`<td>${formatDiff(e)}</td>`:`<td>${formatNumber(e)}</td>`)),makeTableSortable("projectsTable",e,r,["Project","Total","Share","Today","Daily","Weekly","Monthly","Rank","Δ Day","Δ Week","Δ Month","Team Rank","Country Rank"],((t,e)=>"project"===t?`<td>${e.replace(/^"|"$/g,"")}</td>`:t.startsWith("rank_cng_")?`<td>${formatDiff(e)}</td>`:`<td>${formatNumber(e)}</td>`)),makeTableSortable("hostsTable",a,o,["Rank","CPU","Cores","OS","Total","Daily","Weekly","Monthly","Ø"],((t,e)=>"cpu"===t||"os"===t?`<td>${e}</td>`:`<td>${formatNumber(e)}</td>`))}window.addEventListener("DOMContentLoaded",main);