function parseCSVLine(t){const e=[];let a=!1,r="";for(let o=0;o<t.length;++o){const n=t[o];if('"'===n)a=!a;else if(" "!==n||a)r+=n;else for(r.length&&(e.push(r),r="");" "===t[o+1];)++o}return r.length&&e.push(r),e}async function fetchTable(t,e,a){const r=await fetch(t);if(!r.ok)return[];return(await r.text()).split("\n").filter((t=>t.trim())).map(parseCSVLine).filter((t=>!a||"0"!==t[e.indexOf(a)]&&"0.0"!==t[e.indexOf(a)])).map((t=>{let a={};return e.forEach(((e,r)=>a[e]=t[r])),a}))}function formatNumber(t,e=0){return t&&!isNaN(t)?Number(t).toLocaleString("en-US",{minimumFractionDigits:e,maximumFractionDigits:e}):"–"}function formatCompact(t){return t=Number(t),isNaN(t)?"–":Math.abs(t)>=1e6?(t/1e6).toFixed(1).replace(/\.0$/,"")+"M":Math.abs(t)>=1e3?(t/1e3).toFixed(1).replace(/\.0$/,"")+"k":t.toString()}function formatDiff(t,e=0){if(isNaN(t)||null==t)return"–";const a=Number(t);return a>0?`<diff class="up">+${formatNumber(a,e)}</diff>`:a<0?`<diff class="down">${formatNumber(a,e)}</diff>`:'<diff class="equal">±0</diff>'}function formatDate(t){return t?new Date(t).toLocaleDateString("en-US",{year:"2-digit",month:"2-digit",day:"2-digit"}):"–"}function renderHighlights(t){if(!t.length)return;const e=t.length,a=t[e-1];document.querySelector('#highlights [data-item="total_points"]').innerHTML=formatNumber(a.total),document.querySelector('#highlights [data-item="average_points"]').innerHTML=formatNumber(a.total/e,1),document.querySelector('#highlights [data-item="world_rank"]').innerHTML=formatNumber(a.rank),document.querySelector('#highlights [data-item="country_rank"]').innerHTML=formatNumber(a.country_rank),document.querySelector('#highlights [data-item="rank_change"]').innerHTML=formatDiff(a.rank_cng)}function renderCharts(t){if(!t.length)return;const e=(t=t.slice(-60)).map((t=>formatDate(t.date))),a=t.map((t=>Number(t.total))),r=t.map((t=>Number(t.daily))),o=t.map((t=>Number(t.rank))),n=t.map((t=>Number(t.country_rank)));Chart.defaults.font.family='"Archivo", sans-serif';const l={responsive:!0,plugins:{legend:{display:!1},tooltip:{enabled:!0,mode:"index",intersect:!1,padding:{top:10,left:10,right:24,bottom:8},displayColors:!1,titleMarginBottom:0,titleFont:{size:13},titleColor:"#222",bodyFont:{size:20},bodyColor:"#3b82f6",borderColor:"#3b82f6",backgroundColor:"#fff",borderWidth:1,callbacks:{title:t=>t[0].label,label:t=>formatNumber(t.parsed.y)}}},elements:{point:{radius:0},line:{borderWidth:3}},scales:{x:{grid:{color:"#f3f4f6",lineWidth:1},ticks:{color:"#888",maxRotation:0,minRotation:0}},y:{grid:{color:"#f3f4f6",lineWidth:1},ticks:{color:"#888",maxTicksLimit:6,callback:t=>formatCompact(t)}}}};new Chart(document.getElementById("totalPointsChart").getContext("2d"),{type:"line",data:{labels:e,datasets:[{label:"Total Points",data:a,borderColor:"#3b82f6",backgroundColor:"#3b82f611",fill:!0}]},options:l}),new Chart(document.getElementById("rankChart").getContext("2d"),{type:"line",data:{labels:e,datasets:[{label:"World Rank",data:o,borderColor:"#22c55e",backgroundColor:"#22c55e11",fill:!0,stepped:!0}]},options:{...l,scales:{...l.scales,y:{...l.scales.y,reverse:!0}}}}),new Chart(document.getElementById("dailyPointsChart").getContext("2d"),{type:"bar",data:{labels:e,datasets:[{label:"Daily Points",data:r,backgroundColor:"#fbbf24"}]},options:{...l,elements:{bar:{borderRadius:3}},scales:{...l.scales,x:{...l.scales.x,offset:!0},y:{...l.scales.y,min:0}}}}),new Chart(document.getElementById("countryRankChart").getContext("2d"),{type:"line",data:{labels:e,datasets:[{label:"Country Rank",data:n,borderColor:"#8b5cf6",backgroundColor:"#8b5cf611",fill:!0,stepped:!0}]},options:{...l,scales:{...l.scales,y:{...l.scales.y,reverse:!0}}}})}function makeTableSortable(t,e,a,r,o,n=0,l=!1){let i=n,d=l;!function n(l){const s=`<tr>${r.map(((t,e)=>`<th data-idx="${e}" class="sortable ${i===e?"active":""}">${t}${i===e?d?" ▲":" ▼":""}</th>`)).join("")}</tr>`,c=l.map((t=>`<tr>${e.map(((e,a)=>o(e,t[e]))).join("")}</tr>`)).join("");document.getElementById(t).innerHTML=`<thead>${s}</thead><tbody>${c}</tbody>`,document.querySelectorAll(`#${t} th.sortable`).forEach((t=>{t.onclick=()=>{const r=Number(t.dataset.idx);i===r?d=!d:(i=r,d=!0);const o=e[i];n([...a].sort(((t,e)=>{let a=t[o],r=e[o];return isNaN(a)||isNaN(r)||(a=Number(a),r=Number(r)),(a>r?1:a<r?-1:0)*(d?1:-1)})))}}))}(a),document.querySelectorAll(`#${t} th.sortable`)[i].click()}async function main(){const t=["date","total","daily","rank","rank_cng","team_rank","team_cng","country_rank","country_cng"],e=["project","total","share","today","daily","weekly","monthly","rank","rank_cng_day","rank_cng_week","rank_cng_month","team_rank","country_rank"],a=["rank","cpu","cores","os","total","daily","weekly","monthly","avg"],[r,o,n]=await Promise.all([fetchTable("db/daily",t,"total"),fetchTable("db/projects",e),fetchTable("db/hosts",a)]);renderHighlights(r),renderCharts(r),makeTableSortable("dailyTable",t,r,["Date","Total","Daily","Rank","Δ Rank","Team Rank","Δ Team","Country Rank","Δ Country"],((t,e)=>"date"===t?`<td>${formatDate(e)}</td>`:t.endsWith("_cng")?`<td>${formatDiff(e)}</td>`:`<td>${formatNumber(e)}</td>`),0,!0),makeTableSortable("projectsTable",e,o,["Project","Total","Share","Today","Daily","Weekly","Monthly","Rank","Δ Day","Δ Week","Δ Month","Team Rank","Country Rank"],((t,e)=>"project"===t?`<td>${e.replace(/^"|"$/g,"")}</td>`:t.startsWith("rank_cng_")?`<td>${formatDiff(e)}</td>`:`<td>${formatNumber(e)}</td>`)),makeTableSortable("hostsTable",a,n,["Rank","CPU","Cores","OS","Total","Daily","Weekly","Monthly","Ø"],((t,e)=>"cpu"===t||"os"===t?`<td>${e}</td>`:`<td>${formatNumber(e)}</td>`))}window.addEventListener("DOMContentLoaded",main);